<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/engine/sound.js - Panda.js</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                
                    <img class="logo" src="../../img/logo.png" title="Panda.js">
                
                
                    <h1 class="project-name">Panda.js</h1> <span class="project-version">1.0.0</span>
                
                
                    <p class="description">HTML5 game engine</p>
                
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a class="type" href="../classes/game.Body.html">game.Body</a></li>
            
                <li><a class="type" href="../classes/game.Circle.html">game.Circle</a></li>
            
                <li><a class="type" href="../classes/game.Class.html">game.Class</a></li>
            
                <li><a class="type" href="../classes/game.CollisionSolver.html">game.CollisionSolver</a></li>
            
                <li><a class="type" href="../classes/game.Container.html">game.Container</a></li>
            
                <li><a class="type" href="../classes/game.Core.html">game.Core</a></li>
            
                <li><a class="type" href="../classes/game.Debug.html">game.Debug</a></li>
            
                <li><a class="type" href="../classes/game.DebugDraw.html">game.DebugDraw</a></li>
            
                <li><a class="type" href="../classes/game.Emitter.html">game.Emitter</a></li>
            
                <li><a class="type" href="../classes/game.Line.html">game.Line</a></li>
            
                <li><a class="type" href="../classes/game.Loader.html">game.Loader</a></li>
            
                <li><a class="type" href="../classes/game.Particle.html">game.Particle</a></li>
            
                <li><a class="type" href="../classes/game.Pool.html">game.Pool</a></li>
            
                <li><a class="type" href="../classes/game.Rectangle.html">game.Rectangle</a></li>
            
                <li><a class="type" href="../classes/game.Scene.html">game.Scene</a></li>
            
                <li><a class="type" href="../classes/game.SoundManager.html">game.SoundManager</a></li>
            
                <li><a class="type" href="../classes/game.Sprite.html">game.Sprite</a></li>
            
                <li><a class="type" href="../classes/game.Storage.html">game.Storage</a></li>
            
                <li><a class="type" href="../classes/game.System.html">game.System</a></li>
            
                <li><a class="type" href="../classes/game.Timer.html">game.Timer</a></li>
            
                <li><a class="type" href="../classes/game.Tween.html">game.Tween</a></li>
            
                <li><a class="type" href="../classes/game.TweenGroup.html">game.TweenGroup</a></li>
            
                <li><a class="type" href="../classes/game.Vector.html">game.Vector</a></li>
            
                <li><a class="type" href="../classes/game.World.html">game.World</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a class="module" href="../modules/core.html">core</a></li>
            
                <li><a class="module" href="../modules/debug.html">debug</a></li>
            
                <li><a class="module" href="../modules/loader.html">loader</a></li>
            
                <li><a class="module" href="../modules/particle.html">particle</a></li>
            
                <li><a class="module" href="../modules/physics.html">physics</a></li>
            
                <li><a class="module" href="../modules/pool.html">pool</a></li>
            
                <li><a class="module" href="../modules/scene.html">scene</a></li>
            
                <li><a class="module" href="../modules/sound.html">sound</a></li>
            
                <li><a class="module" href="../modules/sprite.html">sprite</a></li>
            
                <li><a class="module" href="../modules/storage.html">storage</a></li>
            
                <li><a class="module" href="../modules/system.html">system</a></li>
            
                <li><a class="module" href="../modules/timer.html">timer</a></li>
            
                <li><a class="module" href="../modules/tween.html">tween</a></li>
            
            </ul>
        </div>
    </div>
</div>

        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: src/engine/sound.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
    @module sound
    @namespace game
**/
game.module(
    &#x27;engine.sound&#x27;,
    &#x27;1.0.0&#x27;
)
.body(function(){ &#x27;use strict&#x27;;

/**
    Instance automatically created at {{#crossLink &quot;game.Core&quot;}}{{/crossLink}}
    @class SoundManager
    @extends game.Class
**/
game.SoundManager = game.Class.extend({
    clips: {},
    loopedSounds: [],
    format: null,
    context: null,
    gainNode: null,
    _muteMusic: false,
    _muteSound: false,
    currentMusic: null,
    /**
        @property {Number} soundVolume
        @default 1.0
    **/
    soundVolume: 1.0,
    /**
        @property {Number} musicVolume
        @default 1.0
    **/
    musicVolume: 1.0,

    init: function(){
        if(game.ua.wp) game.SoundManager.enabled = false;
        
        if(!game.SoundManager.enabled) game.SoundManager.webAudio = false;

        if(game.SoundManager.webAudio) {
            if(!window.webkitAudioContext &amp;&amp; !window.AudioContext) {
                game.SoundManager.webAudio = false;
            }
        }

        if(!navigator.onLine &amp;&amp; game.ua.mobile) {
            game.SoundManager.webAudio = game.SoundManager.enabled = false;
        }

        if(game.SoundManager.enabled &amp;&amp; !game.SoundManager.webAudio &amp;&amp; !window.Audio ) {
            game.SoundManager.enabled = false;
        }

        if(game.SoundManager.webAudio &amp;&amp; game.SoundManager.enabled) {
            game.normalizeVendorAttribute(window, &#x27;AudioContext&#x27;);

            if(window.AudioContext) {
                this.context = new AudioContext();
                if(this.context.createGain) this.gainNode = this.context.createGain();
                else if(this.context.createGainNode) this.gainNode = this.context.createGainNode();
                this.gainNode.connect(this.context.destination);
            } else {
                game.SoundManager.webAudio = false;
            }
        }

        if(game.SoundManager.enabled) {
            var probe = new Audio();
            for(var i = 0; i &lt; game.SoundManager.format.length; i++) {
                var format = game.SoundManager.format[i];
                if(probe.canPlayType(format.mime)) {
                    this.format = format;
                    break;
                }
            }
            if(!this.format) {
                game.SoundManager.enabled = false;
            }
        }
        
        if(!game.SoundManager.enabled) {
            game.SoundCache = {};
            game.MusicCache = {};
        }
    },
        
    get: function(path) {
        var channels = this.clips[path];
        for(var i = 0, clip; clip = channels[i++];) {
            if(clip.paused || clip.ended) {
                if(clip.ended) {
                    clip.currentTime = 0;
                }
                return clip;
            }
        }
        
        channels[0].pause();
        channels[0].currentTime = 0;
        return channels[0];
    },

    getWebAudio: function(path) {
        if(this.context) {
            return this.clips[path];
        }
    },

    unlock: function() {
        if(!this.context) return;
        var buffer = this.context.createBuffer(1, 1, 22050);
        var source = this.context.createBufferSource();
        source.buffer = buffer;
        source.connect(this.context.destination);
        if(source.start) source.start(0);
        else if(source.noteOn) source.noteOn(0);
    },

    decode: function(path, node, loadCallback) {
        var me = this;

        try {
            this.context.decodeAudioData(node, function(buffer) {
                me.clips[path] = [];
                me.clips[path].buffer = buffer;
                if(loadCallback) loadCallback(path, true, buffer);
            }, function() {
                if(loadCallback) loadCallback(path, false);
            });
        } catch(e) {
            if(loadCallback) loadCallback(path, false);
        }
    },

    load: function(path, multiChannel, loadCallback) {
        var a, i, realPath = path.replace(/[^\.]+$/, this.format.ext) + game.nocache;

        if(this.context) {
            var request = new XMLHttpRequest();
            request.open(&#x27;GET&#x27;, realPath, true);
            request.responseType = &#x27;arraybuffer&#x27;;

            var me = this;
            request.onload = function() {
                if(request.response) me.decode(path, request.response, loadCallback);
                else throw &#x27;Null request response on &#x27;+realPath;
            };
            request.send();
            return;
        }

        if(this.clips[path]) {
            if(multiChannel &amp;&amp; this.clips[path].length &lt; game.SoundManager.channels) {
                for(i = this.clips[path].length; i &lt; game.SoundManager.channels; i++ ) {
                    a = new Audio(realPath);
                    a.load();
                    this.clips[path].push(a);
                }
            }
            return this.clips[path][0];
        }
        
        var clip = new Audio(realPath);
        if(loadCallback) {
            clip.addEventListener(&#x27;canplaythrough&#x27;, function cb(ev){
                clip.removeEventListener(&#x27;canplaythrough&#x27;, cb, false);
                loadCallback(path, true, ev);
            }, false);
            
            clip.addEventListener(&#x27;error&#x27;, function(ev){
                loadCallback(realPath, false, ev);
            }, false);
        }
        clip.preload = &#x27;auto&#x27;;
        clip.load();
                
        this.clips[path] = [clip];
        if(multiChannel) {
            for(i = 1; i &lt; game.SoundManager.channels; i++ ) {
                a = new Audio(realPath);
                a.load();
                this.clips[path].push(a);
            }
        }
        
        return clip;
    },

    /**
        @method playSound
        @param {String} name
        @param {Boolean} [loop]
        @param {Number} [delay]
    **/
    playSound: function(name, loop, delay) {
        if(!game.SoundManager.enabled || game.sound._muteSound || typeof(game.SoundCache[name]) === &#x27;undefined&#x27;) return;
        game.SoundCache[name].play(!!loop, delay);
        if(loop) this.loopedSounds.push(game.SoundCache[name]);
    },

    /**
        Stop sound.
        @method stopSound
        @param {String} [name] If not defined, stops all sounds.
    **/
    stopSound: function(name) {
        if(!game.SoundManager.enabled) return;

        if(name) {
            if(typeof(game.SoundCache[name]) === &#x27;undefined&#x27;) return;
            game.SoundCache[name].stop();
            for (var i = 0; i &lt; game.sound.loopedSounds.length; i++) {
                if(game.sound.loopedSounds[i] === game.SoundCache[name]) game.sound.loopedSounds.erase(game.SoundCache[name]);
            }
        } else {
            for(var sound in game.SoundCache) {
                if(game.SoundCache[sound].playing) game.SoundCache[sound].stop();
            }
            this.loopedSounds.length = 0;
        }
    },

    /**
        @method muteSound
    **/
    muteSound: function() {
        if(this._muteSound) return;
        this._muteSound = true;
        for(var sound in game.SoundCache) {
            if(game.SoundCache[sound].playing) game.SoundCache[sound].stop();
        }
    },

    /**
        @method unmuteSound
    **/
    unmuteSound: function() {
        if(!this._muteSound) return;
        this._muteSound = false;
        for (var i = 0; i &lt; this.loopedSounds.length; i++) {
            this.loopedSounds[i].play(true);
        }
    },

    /**
        @method toggleSound
    **/
    toggleSound: function() {
        this._muteSound = !this._muteSound;
        if(this._muteSound) this.muteSound();
        else this.unmuteSound();
    },

    /**
        @method playMusic
        @param {String} name
    **/
    playMusic: function(name) {
        if(!game.SoundManager.enabled || this._muteMusic || typeof(game.MusicCache[name]) === &#x27;undefined&#x27;) return;
        
        if(this.currentMusic &amp;&amp; this.currentMusic.playing) this.currentMusic.stop();
        game.MusicCache[name].play();
        this.currentMusic = game.MusicCache[name];
    },

    /**
        @method stopMusic
    **/
    stopMusic: function() {
        if(!game.SoundManager.enabled) return;

        if(this.currentMusic) {
            if(navigator.isCocoonJS) {
                // BUG
                // CocoonJS drops ~5fps when stopping music (but not when stopping sound, filesize?)
                this.currentMusic.currentClip.volume = 0;
            } else {
                if(this.currentMusic.playing) this.currentMusic.stop();
            }
            this.currentMusic = null;
        }
    },

    /**
        @method muteMusic
    **/
    muteMusic: function() {
        if(this._muteMusic) return;
        this._muteMusic = true;
        if(this.currentMusic) this.currentMusic.stop();
    },

    /**
        @method unmuteMusic
    **/
    unmuteMusic: function() {
        if(!this._muteMusic) return;
        this._muteMusic = false;
        if(this.currentMusic) this.currentMusic.play();
    },

    /**
        @method toggleMusic
    **/
    toggleMusic: function() {
        this._muteMusic = !this._muteMusic;
        if(this._muteMusic) this.muteMusic();
        else this.unmuteMusic();
    },

    /**
        Stops all sounds and music.
        @method stopAll
    **/
    stopAll: function() {
        this.stopSound();
        this.stopMusic();
    },

    /**
        @method muteAll
    **/
    muteAll: function() {
        this.muteSound();
        this.muteMusic();
    },

    /**
        @method unmuteAll
    **/
    unmuteAll: function() {
        this.unmuteSound();
        this.unmuteMusic();
    }
});

game.SoundManager.FORMAT = {
    MP3: {ext: &#x27;mp3&#x27;, mime: &#x27;audio/mpeg&#x27;},
    M4A: {ext: &#x27;m4a&#x27;, mime: &#x27;audio/mp4; codecs=mp4a&#x27;},
    OGG: {ext: &#x27;ogg&#x27;, mime: &#x27;audio/ogg; codecs=vorbis&#x27;},
    WEBM: {ext: &#x27;webm&#x27;, mime: &#x27;audio/webm; codecs=vorbis&#x27;},
    CAF: {ext: &#x27;caf&#x27;, mime: &#x27;audio/x-caf&#x27;}
};

game.SoundManager.format = [game.SoundManager.FORMAT.OGG, game.SoundManager.FORMAT.M4A];
game.SoundManager.channels = 4;
game.SoundManager.enabled = true;
/**
    Use Web Audio API.
    @attribute {Boolean} webAudio
**/
game.SoundManager.webAudio = true;

game.Sound = game.Class.extend({
    path: &#x27;&#x27;,
    volume: 1,
    currentClip: null,
    multiChannel: false,
    gainNode: null,
    playbackRate: 1,
    channels: 4,
    loop: false,
    
    init: function(path, multiChannel) {
        this.path = path;
        this.multiChannel = !!multiChannel;
        this.load();
    },

    load: function(loadCallback) {
        if(!game.SoundManager.enabled) {
            if(loadCallback) loadCallback(this.path, true);
            return;
        }
        
        if(game.ready) {
            if(game.sound.context) {
                if(game.sound.context.createGain) this.gainNode = game.sound.context.createGain();
                else if(game.sound.context.createGainNode) this.gainNode = game.sound.context.createGainNode();
                this.gainNode.connect(game.sound.gainNode);
            }
            game.sound.load(this.path, this.multiChannel, loadCallback);
        }
        else {
            game.audioResources.push(this);
        }

        if(game.ready &amp;&amp; game.sound &amp;&amp; !game.SoundManager.webAudio &amp;&amp; game.SoundManager.enabled) {
            this.currentClip = game.sound.get(this.path);
            this.currentClip.addEventListener(&#x27;ended&#x27;, this.ended.bind(this), false);
        }
    },

    ended: function() {
        if(this.loop) this.play();
        else this.playing = false;
    },

    prePlay: function(loop) {
        this.loop = !!loop;
        this._volume = game.sound.soundVolume * this.volume;
        return true;
    },

    play: function(loop, delay) {
        if(!game.SoundManager.enabled) return;
        
        if(!this.prePlay(loop)) return;

        this.playing = true;

        if(game.sound.context) {
            // Web Audio
            this.currentClip = game.sound.getWebAudio(this.path);
            
            var source = game.sound.context.createBufferSource();
            source.buffer = this.currentClip.buffer;
            source.loop = this.loop;
            this.gainNode.gain.value = this._volume;
            source.playbackRate.value = this.playbackRate;
            source.connect(this.gainNode);
            this.currentClip.source = source;
            var _delay = delay ? game.sound.context.currentTime + delay : 0;
            if(this.currentClip.source.start) this.currentClip.source.start(_delay);
            else if(this.currentClip.source.noteOn) this.currentClip.source.noteOn(_delay);
        } else {
            // HTML5 Audio
            this.currentClip.loop = !!this.loop;
            this.currentClip = game.sound.get(this.path);
            this.currentClip.volume = this._volume;
            this.currentClip.play();
        }
    },

    setPlaybackRate: function(value) {
        if(!game.SoundManager.enabled || !game.SoundManager.webAudio) return;

        this.playbackRate = value;
        this.currentClip = game.sound.getWebAudio(this.path);
        if(game.sound.context &amp;&amp; this.currentClip.source) {
            this.currentClip.source.playbackRate.value = this.playbackRate;
        }
    },

    setLoop: function(value) {
        this.loop = !!value;
    },

    setVolume: function(value) {
        if(!game.SoundManager.enabled || !game.SoundManager.webAudio) {
            if(this.currentClip) this.currentClip.volume = value;
            return;
        }
        
        if(game.sound.context &amp;&amp; this.gainNode) {
            this.gainNode.gain.value = value;
        }
    },

    stop: function() {
        if(!game.SoundManager.enabled) return;

        if(!this.playing) return;
        this.playing = false;

        if(this.currentClip &amp;&amp; game.sound.context) {
            // Web Audio
            if(this.currentClip.source) {
                if(this.currentClip.source.stop) this.currentClip.source.stop(0);
                else if(this.currentClip.source.noteOff) this.currentClip.source.noteOff(0);
            }
        } else {
            // HTML5 Audio
            if(this.currentClip) {
                this.currentClip.pause();
                this.currentClip.currentTime = 0;
            }
        }
    }
});

game.Music = game.Sound.extend({
    prePlay: function() {
        this.loop = true;
        this._volume = game.sound.musicVolume * this.volume;
        return true;
    }
});

game.SoundCache = {};
game.MusicCache = {};

});
    </pre>
</div>

            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
