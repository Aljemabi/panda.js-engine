<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/engine/loader.js - Panda.js</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                
                    <img class="logo" src="../../logo.png" title="Panda.js">
                
                
                    <h1 class="project-name">Panda.js</h1> <span class="project-version">1.0.0</span>
                
                
                    <p class="description">HTML5 game engine</p>
                
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a class="type" href="../classes/game.Body.html">game.Body</a></li>
            
                <li><a class="type" href="../classes/game.Circle.html">game.Circle</a></li>
            
                <li><a class="type" href="../classes/game.Class.html">game.Class</a></li>
            
                <li><a class="type" href="../classes/game.CollisionSolver.html">game.CollisionSolver</a></li>
            
                <li><a class="type" href="../classes/game.Core.html">game.Core</a></li>
            
                <li><a class="type" href="../classes/game.Debug.html">game.Debug</a></li>
            
                <li><a class="type" href="../classes/game.Line.html">game.Line</a></li>
            
                <li><a class="type" href="../classes/game.Loader.html">game.Loader</a></li>
            
                <li><a class="type" href="../classes/game.Pool.html">game.Pool</a></li>
            
                <li><a class="type" href="../classes/game.Rectangle.html">game.Rectangle</a></li>
            
                <li><a class="type" href="../classes/game.Scene.html">game.Scene</a></li>
            
                <li><a class="type" href="../classes/game.SoundManager.html">game.SoundManager</a></li>
            
                <li><a class="type" href="../classes/game.Sprite.html">game.Sprite</a></li>
            
                <li><a class="type" href="../classes/game.Storage.html">game.Storage</a></li>
            
                <li><a class="type" href="../classes/game.System.html">game.System</a></li>
            
                <li><a class="type" href="../classes/game.Timer.html">game.Timer</a></li>
            
                <li><a class="type" href="../classes/game.Tween.html">game.Tween</a></li>
            
                <li><a class="type" href="../classes/game.Vector.html">game.Vector</a></li>
            
                <li><a class="type" href="../classes/game.World.html">game.World</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a class="module" href="../modules/core.html">core</a></li>
            
                <li><a class="module" href="../modules/debug.html">debug</a></li>
            
                <li><a class="module" href="../modules/loader.html">loader</a></li>
            
                <li><a class="module" href="../modules/physics.html">physics</a></li>
            
                <li><a class="module" href="../modules/pool.html">pool</a></li>
            
                <li><a class="module" href="../modules/scene.html">scene</a></li>
            
                <li><a class="module" href="../modules/sound.html">sound</a></li>
            
                <li><a class="module" href="../modules/sprite.html">sprite</a></li>
            
                <li><a class="module" href="../modules/storage.html">storage</a></li>
            
                <li><a class="module" href="../modules/system.html">system</a></li>
            
                <li><a class="module" href="../modules/timer.html">timer</a></li>
            
                <li><a class="module" href="../modules/tween.html">tween</a></li>
            
            </ul>
        </div>
    </div>
</div>

        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: src/engine/loader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
    @module loader
    @namespace game
**/
game.module(
    &#x27;engine.loader&#x27;,
    &#x27;1.0.0&#x27;
)
.body(function(){ &#x27;use strict&#x27;;

/**
    @class Loader
    @extends game.Class
**/
game.Loader = game.Class.extend({
    resources: [],
    
    gameClass: null,
    status: 0,
    done: false,
    
    _unloaded: [],
    _drawStatus: 0,
    _intervalId: 0,
    _loadCallbackBound: null,
    _loaded: 0,

    assets: [],
    audioAssets: [],
    audioUnloaded: [],
    percent: 0,
    startTime: null,
    endTime: null,

    init: function( gameClass, resources, audioResources ) {
        if(this.clearColor) {
            var bg = new game.Graphics();
            bg.beginFill(this.clearColor);
            bg.drawRect(0,0,game.system.width,game.system.height);
            game.system.stage.addChild(bg);
        }

        this.gameClass = gameClass;

        for (var i = 0; i &lt; resources.length; i++) {
            var path = this.getPath(resources[i]);
            this.assets.push(path);
        }

        for (i = 0; i &lt; audioResources.length; i++) {
            this.audioAssets.push(audioResources[i]);
            this.audioUnloaded.push(audioResources[i].path);
        }

        this.loader = new game.AssetLoader(this.assets);
        this.loader.onProgress = this.progress.bind(this);
        this.loader.onComplete = this.complete.bind(this);
        this.loader.onError = this.error.bind(this);

        if(this.assets.length === 0) this.percent = 100;

        this.initStage();

        if(this.assets.length === 0) this.ready();
        else this.startTime = Date.now();
    },

    getPath: function(path) {
        return game.system.retina || game.system.hires ? path.replace(/\.(?=[^.]*$)/, &#x27;@2x.&#x27;) : path;
    },

    start: function() {
        this.loader.load();
        this._intervalId = setInterval( this.render.bind(this), 16 );
    },

    initStage: function() {
        this.text = new game.Text(this.percent+&#x27;%&#x27;,{font:&#x27;30px Arial&#x27;,fill:&#x27;#ffffff&#x27;});
        this.text.position.x = game.system.width / 2 - this.text.width / 2;
        this.text.position.y = game.system.height/2 - 30/2;
        game.system.stage.addChild(this.text);

        this.symbol = new game.Sprite.fromImage(&#x27;data:image/png;base64,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&#x27;);
        this.symbol.anchor.x = this.symbol.anchor.y = 0.5;
        this.symbol.position.x = game.system.width/2;
        this.symbol.position.y = game.system.height/2;
        game.system.stage.addChild(this.symbol);
    },

    loadResource: function( res ) {
        res.load( this._loadCallbackBound );
    },

    _loadCallback: function( path, status ) {
        if( status ) {
            this._unloaded.erase( path );
        }
        else {
            throw( &#x27;Failed to load resource: &#x27; + path );
        }
        
        this.status = 1 - (this._unloaded.length / this.resources.length);
        if( this._unloaded.length === 0 ) { // all done?
            setTimeout( this.end.bind(this), 250 );
        }
    },

    error: function() {
        this.text.setText(&#x27;ERR&#x27;);
        this.text.updateTransform();
        this.text.position.x = game.system.width / 2 - this.text.width / 2;
        this.onPercentChange = function() {};
    },

    progress: function() {
        this._loaded++;
        this.status = this._loaded / (this.assets.length + this.audioAssets.length);
        this.percent = Math.round(this._loaded / (this.assets.length + this.audioAssets.length) * 100);
        this.onPercentChange();
    },

    onPercentChange: function() {
        this.text.setText(this.percent+&#x27;%&#x27;);
        this.text.updateTransform();
        this.text.position.x = game.system.width / 2 - this.text.width / 2;
    },

    complete: function() {
        if(this.audioAssets.length &gt; 0) this.loadAudio();
        else this.ready();
    },

    loadAudio: function() {
        for (var i = this.audioAssets.length - 1; i &gt;= 0; i--) {
            this.audioAssets[i].load(this.audioLoaded.bind(this));
        }
    },

    audioLoaded: function(path, status) {
        this.progress();

        if(status) {
            this.audioUnloaded.erase(path);
        }
        else {
            if(this.text) this.text.setText(&#x27;ERR&#x27;);
            throw( &#x27;Failed to load resource: &#x27; + path );
        }

        if(this.audioUnloaded.length === 0) this.ready();
    },

    draw: function() {
        this.symbol.rotation += 0.2;
    },

    render: function() {
        this.draw();
        game.system.renderer.render(game.system.stage);
    },

    ready: function() {
        var timeout = game.Loader.timeout;
        if(this.startTime) {
            this.endTime = Date.now();
            timeout -= this.endTime - this.startTime;
        }
        if(timeout &lt; 100) timeout = 100;
        setTimeout(this.end.bind(this), timeout);
    },

    end: function() {
        if( this.done ) { return; }
        
        // remove @2x from TextureCache
        for(var i in game.TextureCache) {
            if(i.indexOf(&#x27;@2x&#x27;) !== -1) {
                game.TextureCache[i.replace(&#x27;@2x&#x27;, &#x27;&#x27;)] = game.TextureCache[i];
                delete game.TextureCache[i];
            }
        }

        this.done = true;
        clearInterval( this._intervalId );
        game.system.setScene( this.gameClass );
    }
});

/**
    Minimum time to show preloader. In milliseconds.
    @attribute {Number} timeout
    @default 500
    @example
        game.Loader.timeout = 1000;
**/
game.Loader.timeout = 500;

});
    </pre>
</div>

            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
